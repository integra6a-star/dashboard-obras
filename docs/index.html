<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Dashboard – Extensão de Obra</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial; margin: 14px; background:#f4f6f8 }
    h2 { text-align:center; margin: 8px 0 14px; }
    .filters { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:10px; }
    select { width:100%; padding:10px; border-radius:10px; border:1px solid #ddd; background:#fff; }

    .cards { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin: 10px 0 14px; }
    .card { background:#fff; padding:12px; border-radius:12px; box-shadow:0 0 6px rgba(0,0,0,0.08); text-align:center; }
    .card h4 { margin:0 0 6px; font-size:13px; color:#444; font-weight:600; }
    .card h3 { margin:0; font-size:20px; }

    .panel { background:#fff; padding:12px; border-radius:12px; box-shadow:0 0 6px rgba(0,0,0,0.08); margin-bottom:12px; }
    .meta { color:#666; font-size:12px; margin: -6px 0 12px; text-align:center; }

    @media(max-width: 800px){
      .filters { grid-template-columns: 1fr; }
      .cards { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <h2>Dashboard – Extensão / PV / Economias</h2>
  <div class="meta" id="meta">Carregando…</div>

  <div class="filters">
    <select id="fObra"></select>
    <select id="fBloco"></select>
    <select id="fTipo"></select>
  </div>

  <div class="cards">
    <div class="card"><h4>Planejado (m)</h4><h3 id="kpiPlan">0</h3></div>
    <div class="card"><h4>Executado (m)</h4><h3 id="kpiExec">0</h3></div>
    <div class="card"><h4>% Executado</h4><h3 id="kpiPerc">0%</h3></div>

    <div class="card"><h4>Desvio (m)</h4><h3 id="kpiDesv">0</h3></div>
    <div class="card"><h4>Economias Previstas</h4><h3 id="kpiEconPrev">0</h3></div>
    <div class="card"><h4>Economias Recebidas</h4><h3 id="kpiEconRec">0</h3></div>
  </div>

  <div class="panel">
    <h4 style="margin:0 0 10px;">Planejado x Executado por Bloco</h4>
    <canvas id="grafExt"></canvas>
  </div>

  <div class="panel">
    <h4 style="margin:0 0 10px;">Economias Previstas x Recebidas por Bloco</h4>
    <canvas id="grafEcon"></canvas>
  </div>

<script>
let RAW = [];
let chartExt, chartEcon;

function uniq(arr){ return [...new Set(arr)].filter(x => x !== undefined && x !== null && x !== ""); }

function fillSelect(sel, items, labelAll){
  sel.innerHTML = "";
  const optAll = document.createElement("option");
  optAll.value = "";
  optAll.textContent = labelAll;
  sel.appendChild(optAll);
  items.forEach(v => {
    const o = document.createElement("option");
    o.value = v;
    o.textContent = v;
    sel.appendChild(o);
  });
}

function filtered(){
  const obra = fObra.value;
  const bloco = fBloco.value;
  const tipo = fTipo.value;

  return RAW.filter(r => {
    if (obra && r.Obra !== obra) return false;
    if (bloco && r.Bloco !== bloco) return false;
    if (tipo && r.Tipo !== tipo) return false;
    return true;
  });
}

function groupByBloco(rows){
  const map = new Map();
  rows.forEach(r => {
    const key = r.Bloco ?? "—";
    if (!map.has(key)){
      map.set(key, {
        Bloco: key,
        Planejado_m: 0,
        Executado_m: 0,
        Economias_Previstas: 0,
        Economias_Recebidas: 0
      });
    }
    const cur = map.get(key);
    cur.Planejado_m += Number(r.Planejado_m || 0);
    cur.Executado_m += Number(r.Executado_m || 0);
    cur.Economias_Previstas += Number(r.Economias_Previstas || 0);
    cur.Economias_Recebidas += Number(r.Economias_Recebidas || 0);
  });

  return [...map.values()].sort((a,b) => String(a.Bloco).localeCompare(String(b.Bloco)));
}

function updateKPIs(rows){
  const plan = rows.reduce((s,r)=>s+Number(r.Planejado_m||0),0);
  const exec = rows.reduce((s,r)=>s+Number(r.Executado_m||0),0);
  const econPrev = rows.reduce((s,r)=>s+Number(r.Economias_Previstas||0),0);
  const econRec = rows.reduce((s,r)=>s+Number(r.Economias_Recebidas||0),0);

  const perc = plan > 0 ? (exec/plan*100) : 0;

  kpiPlan.textContent = plan.toFixed(1);
  kpiExec.textContent = exec.toFixed(1);
  kpiPerc.textContent = perc.toFixed(1) + "%";
  kpiDesv.textContent = (plan - exec).toFixed(1);
  kpiEconPrev.textContent = econPrev.toFixed(0);
  kpiEconRec.textContent = econRec.toFixed(0);
}

function renderCharts(rows){
  const byBloco = groupByBloco(rows);
  const labels = byBloco.map(x => x.Bloco);

  const dataPlan = byBloco.map(x => x.Planejado_m);
  const dataExec = byBloco.map(x => x.Executado_m);

  if (chartExt) chartExt.destroy();
  chartExt = new Chart(document.getElementById("grafExt"), {
    type:"bar",
    data:{ labels, datasets:[
      { label:"Planejado (m)", data:dataPlan },
      { label:"Executado (m)", data:dataExec }
    ]},
    options:{ responsive:true }
  });

  const dataEPrev = byBloco.map(x => x.Economias_Previstas);
  const dataERec  = byBloco.map(x => x.Economias_Recebidas);

  if (chartEcon) chartEcon.destroy();
  chartEcon = new Chart(document.getElementById("grafEcon"), {
    type:"bar",
    data:{ labels, datasets:[
      { label:"Economias Previstas", data:dataEPrev },
      { label:"Economias Recebidas", data:dataERec }
    ]},
    options:{ responsive:true }
  });
}

function update(){
  const rows = filtered();
  updateKPIs(rows);
  renderCharts(rows);
}

async function init(){
  const res = await fetch("./dados.json?cachebust=" + Date.now());
  const json = await res.json();
  RAW = json.registros || [];

  meta.textContent = `Atualizado em: ${json.atualizado_em || "-"} | Linhas: ${RAW.length}`;

  fillSelect(fObra, uniq(RAW.map(r=>r.Obra)).sort(), "Todas as Obras");
  fillSelect(fBloco, uniq(RAW.map(r=>r.Bloco)).sort(), "Todos os Blocos");
  fillSelect(fTipo, uniq(RAW.map(r=>r.Tipo)).sort(), "Todos os Tipos");

  [fObra,fBloco,fTipo].forEach(el => el.addEventListener("change", update));
  update();
}
init();
</script>

</body>
</html>
