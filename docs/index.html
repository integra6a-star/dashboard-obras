<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard – Consórcio Desenvolvimento Sustentável INTEGRA</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{font-family:Arial;margin:14px;background:#f4f6f8}
    .container{max-width:1400px;margin:0 auto}

    /* ======= HEADER com LOGO (esquerda) ======= */
    .header{
      background:#fff;border-radius:18px;
      box-shadow:0 0 14px rgba(0,0,0,.06);
      padding:14px 18px;margin-bottom:14px;
      display:flex;gap:14px;align-items:center;justify-content:space-between;
    }
    .brand{display:flex;align-items:center;gap:14px}
    .brand img{height:64px; width:auto; object-fit:contain} /* maior */
    .brand .title{
      display:flex;flex-direction:column;gap:2px;
    }
    .brand .title h1{margin:0;font-size:18px}
    .brand .title small{color:#6b7280}
    .header-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      border:1px solid #e3e7ee;background:#fff;border-radius:12px;
      padding:10px 12px;cursor:pointer;font-weight:700;
    }
    .btn.primary{background:#0b57d0;color:#fff;border-color:#0b57d0}
    .btn:active{transform:scale(.99)}
    .pill{
      font-size:12px;color:#111; background:#eef2ff; border:1px solid #dbeafe;
      padding:6px 10px;border-radius:999px;
    }

    .top-filters{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:14px}
    .filter label{display:block;font-size:13px;color:#444;margin:0 0 6px}
    select{width:100%;padding:12px;border-radius:12px;border:1px solid #e3e7ee;background:#fff}

    .cards{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:14px}
    .card{background:#fff;border-radius:14px;box-shadow:0 0 10px rgba(0,0,0,.06);padding:14px}
    .card .t{font-size:13px;color:#555;margin-bottom:8px}
    .card .v{font-size:30px;font-weight:800;color:#0b57d0;line-height:1}
    .card .s{font-size:12px;color:#777;margin-top:8px}
    /* card meta (avanço) */
    .card.av-meta .v{color:#0b57d0}
    .card.av-meta.good{outline:2px solid rgba(16,185,129,.35)}
    .card.av-meta.good .v{color:#059669}
    .card.av-meta.warn{outline:2px solid rgba(245,158,11,.35)}
    .card.av-meta.warn .v{color:#d97706}
    .card.av-meta.bad{outline:2px solid rgba(239,68,68,.35)}
    .card.av-meta.bad .v{color:#dc2626}

    .grid2{display:grid;grid-template-columns:2fr 1fr;gap:14px;margin-bottom:14px}
    .grid2b{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-bottom:14px}
    .panel{background:#fff;border-radius:14px;box-shadow:0 0 10px rgba(0,0,0,.06);padding:14px}
    .panel h3{margin:0 0 6px;font-size:16px}
    .panel small{color:#6b7280}
    .meta{color:#666;font-size:12px;margin:10px 0 0;text-align:right}

    /* alertas */
    .alerts{display:flex;flex-direction:column;gap:10px}
    .alert{
      border-radius:12px;padding:10px 12px;border:1px solid #e5e7eb;background:#f9fafb;
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
    }
    .alert strong{display:block}
    .alert.bad{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.06)}
    .alert.warn{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.06)}
    .alert.good{border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.06)}
    .alert .tag{font-size:12px;color:#111;padding:3px 8px;border-radius:999px;background:#fff;border:1px solid #e5e7eb;white-space:nowrap}

    /* tabela */
    .table-wrap{background:#fff;border-radius:14px;box-shadow:0 0 10px rgba(0,0,0,.06);overflow:hidden}
    .table-head{display:flex;justify-content:space-between;align-items:center;padding:14px}
    .table-head h3{margin:0;font-size:16px}
    .table-head small{color:#6b7280}
    table{width:100%;border-collapse:collapse;font-size:14px}
    thead th{
      background:#1f5fe0;color:#fff;padding:12px 10px;text-align:left;
      cursor:pointer;user-select:none;white-space:nowrap;
    }
    thead th .arrow{opacity:.85;margin-left:6px;font-size:12px}
    tbody td{padding:10px;border-bottom:1px solid #eee}
    tbody tr:nth-child(even){background:#f7fbff}
    td.num{text-align:right;font-variant-numeric:tabular-nums}

    @media(max-width:1100px){
      .cards{grid-template-columns:repeat(2,1fr)}
      .grid2{grid-template-columns:1fr}
      .grid2b{grid-template-columns:1fr}
      .grid3{grid-template-columns:1fr}
      .brand img{height:56px}
    }
    @media(max-width:700px){
      .top-filters{grid-template-columns:1fr}
      .cards{grid-template-columns:1fr}
      .header{flex-direction:column;align-items:flex-start}
      .header-actions{width:100%}
    }

    /* ====== PDF / impressão ====== */
    @media print{
      body{background:#fff;margin:0}
      .btn,.header-actions{display:none !important}
      .panel,.card,.table-wrap,.header{box-shadow:none !important}
      .container{max-width:none;margin:0}
      canvas{max-height:360px !important}
    }
  </style>
</head>

<body>
<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div class="brand">
      <!-- Coloque o seu logo aqui: docs/logo.png -->
      <img src="./logo.png" alt="Logo INTEGRA" onerror="this.style.display='none'">
      <div class="title">
        <h1>Dashboard – Acompanhamento de Obra</h1>
        <small>Consórcio Desenvolvimento Sustentável INTEGRA</small>
      </div>
    </div>
    <div class="header-actions">
      <span class="pill" id="pAtualizado">Atualizado: -</span>
      <button class="btn" id="btnRefresh">Recarregar dados</button>
      <button class="btn primary" id="btnPDF">Exportar PDF</button>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="top-filters">
    <div class="filter">
      <label>Obra</label>
      <select id="fObra"></select>
    </div>
    <div class="filter">
      <label>Bloco</label>
      <select id="fBloco"></select>
    </div>
    <div class="filter">
      <label>Tipo de extensão</label>
      <select id="fTipo"></select>
    </div>
  </div>

  <!-- CARDS -->
  <div class="cards">
    <div class="card">
      <div class="t">Extensão Planejada (m)</div>
      <div class="v" id="kPlan">0</div>
      <div class="s">Somatório do filtro</div>
    </div>

    <div class="card">
      <div class="t">Extensão Executada (m)</div>
      <div class="v" id="kExec">0</div>
      <div class="s">Somatório do filtro</div>
    </div>

    <div class="card">
      <div class="t">Saldo a Executar (m)</div>
      <div class="v" id="kSaldo">0</div>
      <div class="s">Planejado − Executado</div>
    </div>

    <div class="card av-meta" id="cardAvanco">
      <div class="t">Avanço (%)</div>
      <div class="v" id="kAvanco">0%</div>
      <div class="s">Executado / Planejado</div>
    </div>

    <div class="card">
      <div class="t">PV (qtd)</div>
      <div class="v" id="kPV">0</div>
      <div class="s">Somatório do filtro</div>
    </div>

    <div class="card">
      <div class="t">Profundidade PV (m)</div>
      <div class="v" id="kProf">0</div>
      <div class="s">Somatório do filtro</div>
    </div>

    <div class="card">
      <div class="t">Economias previstas</div>
      <div class="v" id="kEcoPrev">0</div>
      <div class="s">Somatório do filtro</div>
    </div>

    <div class="card">
      <div class="t">Economias recebidas</div>
      <div class="v" id="kEcoRec">0</div>
      <div class="s">Somatório do filtro</div>
    </div>
  </div>

  <!-- GRÁFICOS PRINCIPAIS -->
  <div class="grid2">
    <div class="panel">
      <h3>Planejado × Executado por Obra</h3>
      <small>Colunas agrupadas</small>
      <div style="height:420px"><canvas id="chObra"></canvas></div>
      <div class="meta" id="meta"></div>
    </div>

    <div class="panel">
      <h3>Distribuição por Tipo</h3>
      <small>Participação do Planejado (m)</small>
      <div style="height:420px"><canvas id="chTipo"></canvas></div>
    </div>
  </div>

  <!-- AVANÇO / TOP10 -->
  <div class="grid2b">
    <div class="panel">
      <h3>Avanço (%) por Bloco</h3>
      <small>Executado / Planejado</small>
      <div style="height:360px"><canvas id="chAvancoBloco"></canvas></div>
    </div>

    <div class="panel">
      <h3>Ranking – Top 10 Executado (m)</h3>
      <small>Blocos com maior produção</small>
      <div style="height:360px"><canvas id="chTop10"></canvas></div>
    </div>
  </div>

  <!-- FORECAST / CURVA S / ALERTAS -->
  <div class="grid3">
    <div class="panel">
      <h3>Curva S + Forecast</h3>
      <small id="sForecast">Precisa de uma coluna de data para habilitar (ex.: Data, data, Semana, semana)</small>
      <div style="height:320px"><canvas id="chCurvaS"></canvas></div>
    </div>

    <div class="panel">
      <h3>Alertas automáticos</h3>
      <small>Meta padrão: 85% (ajustável no código)</small>
      <div class="alerts" id="alerts"></div>
    </div>

    <div class="panel">
      <h3>Ranking de riscos (Top 10)</h3>
      <small>Heurística: baixo avanço + saldo alto + planejado alto</small>
      <div style="height:320px"><canvas id="chRiscos"></canvas></div>
    </div>
  </div>

  <!-- TABELA -->
  <div class="table-wrap">
    <div class="table-head">
      <div>
        <h3>Tabela detalhada</h3>
        <small>Ordene clicando no cabeçalho</small>
      </div>
      <small id="linhasInfo">Linhas: 0</small>
    </div>
    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th data-col="Obra">Obra <span class="arrow" id="aObra"></span></th>
            <th data-col="Bloco">Bloco <span class="arrow" id="aBloco"></span></th>
            <th data-col="Tipo">Tipo <span class="arrow" id="aTipo"></span></th>
            <th data-col="Planejado_m" class="num">Planejado (m) <span class="arrow" id="aPlan"></span></th>
            <th data-col="Executado_m" class="num">Executado (m) <span class="arrow" id="aExec"></span></th>
            <th data-col="Avanco" class="num">Avanço (%) <span class="arrow" id="aAv"></span></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
/** ========= CONFIG ========= */
const META_AVANCO = 85; // meta de avanço (%), ajuste aqui

/** ========= STATE ========= */
let RAW = [];        // já normalizado
let chartObra, chartTipo, chartAvBloco, chartTop10, chartCurvaS, chartRiscos;
let sortState = { col: "Obra", dir: "asc" };

/** ========= HELPERS ========= */
function uniq(arr){ return [...new Set(arr)].filter(x=>x!==null && x!==undefined && x!==""); }
function fillSelect(sel, items, labelAll){
  sel.innerHTML = "";
  sel.add(new Option(labelAll, ""));
  items.forEach(v => sel.add(new Option(v, v)));
}
const fmtInt = (n)=> Number(n||0).toLocaleString("pt-BR",{maximumFractionDigits:0});
const fmt1   = (n)=> Number(n||0).toLocaleString("pt-BR",{minimumFractionDigits:1, maximumFractionDigits:1});
const fmtPct0= (n)=> (Number(n||0).toFixed(0)+"%");

/** Normaliza para funcionar com JSON que vem com chaves minúsculas/maiúsculas */
function normalizeRow(r){
  // aceita variantes:
  const Obra = r.Obra ?? r.obra ?? r.OBRA ?? "";
  const Bloco = r.Bloco ?? r.bloco ?? r.BLOCO ?? "";
  const Tipo = r.Tipo ?? r.tipo ?? r.TIPO ?? "";

  const Planejado_m = r.Planejado_m ?? r.planejado_m ?? r.Planejado ?? r.planejado ?? 0;
  const Executado_m = r.Executado_m ?? r.executado_m ?? r.Executado ?? r.executado ?? 0;

  const PV = r.PV ?? r.pv ?? 0;
  const Profundidade_m = r.Profundidade_m ?? r.profundidade_m ?? r.Profundidade ?? r.profundidade ?? 0;
  const Economias_Previstas = r.Economias_Previstas ?? r.economias_previstas ?? 0;
  const Economias_Recebidas = r.Economias_Recebidas ?? r.economias_recebidas ?? 0;

  // opcional: data/semana para Curva S (se não existir, curva S fica desabilitada)
  const Data = r.Data ?? r.data ?? r.Semana ?? r.semana ?? null;

  return {
    Obra, Bloco, Tipo,
    Planejado_m:Number(Planejado_m||0),
    Executado_m:Number(Executado_m||0),
    PV:Number(PV||0),
    Profundidade_m:Number(Profundidade_m||0),
    Economias_Previstas:Number(Economias_Previstas||0),
    Economias_Recebidas:Number(Economias_Recebidas||0),
    Data
  };
}

function filtered(){
  const obra=fObra.value, bloco=fBloco.value, tipo=fTipo.value;
  return RAW.filter(r => (!obra || r.Obra===obra) && (!bloco || r.Bloco===bloco) && (!tipo || r.Tipo===tipo));
}

function groupBy(rows, key){
  const map = new Map();
  rows.forEach(r=>{
    const k = (r[key] ?? "—");
    if(!map.has(k)) map.set(k,{k, P:0, E:0, PV:0, Prof:0, EP:0, ER:0});
    const cur = map.get(k);
    cur.P += Number(r.Planejado_m||0);
    cur.E += Number(r.Executado_m||0);
    cur.PV += Number(r.PV||0);
    cur.Prof += Number(r.Profundidade_m||0);
    cur.EP += Number(r.Economias_Previstas||0);
    cur.ER += Number(r.Economias_Recebidas||0);
  });
  return [...map.values()];
}

function avancoPct(P,E){
  if(!P || P<=0) return null;
  return (E/P*100);
}

function setCardAvancoColor(pct){
  cardAvanco.classList.remove("good","warn","bad");
  if(pct >= 90) cardAvanco.classList.add("good");
  else if(pct >= 70) cardAvanco.classList.add("warn");
  else cardAvanco.classList.add("bad");
}

/** ========= ALERTAS + RISCOS ========= */
function renderAlerts(rows){
  const el = document.getElementById("alerts");
  el.innerHTML = "";

  const plan = rows.reduce((s,r)=>s+Number(r.Planejado_m||0),0);
  const exec = rows.reduce((s,r)=>s+Number(r.Executado_m||0),0);
  const av = plan>0 ? exec/plan*100 : 0;
  const saldo = plan - exec;

  // 1) alerta meta
  if(plan > 0){
    if(av < META_AVANCO){
      el.appendChild(makeAlert("bad",
        `Avanço abaixo da meta (${fmtPct0(av)} < ${META_AVANCO}%)`,
        `Saldo: ${fmtInt(saldo)} m`
      ));
    } else {
      el.appendChild(makeAlert("good",
        `Avanço dentro/acima da meta (${fmtPct0(av)} ≥ ${META_AVANCO}%)`,
        `Saldo: ${fmtInt(saldo)} m`
      ));
    }
  }

  // 2) economia: recebida menor que prevista
  const ecoPrev = rows.reduce((s,r)=>s+Number(r.Economias_Previstas||0),0);
  const ecoRec  = rows.reduce((s,r)=>s+Number(r.Economias_Recebidas||0),0);
  if(ecoPrev > 0 && ecoRec < ecoPrev){
    el.appendChild(makeAlert("warn",
      `Economias recebidas abaixo do previsto`,
      `Prev: ${fmtInt(ecoPrev)} | Rec: ${fmtInt(ecoRec)}`
    ));
  }

  // 3) blocos críticos (top 3 menor avanço com planejado > 0)
  const byBloco = groupBy(rows,"Bloco")
    .map(x=>({ ...x, pct: avancoPct(x.P,x.E) }))
    .filter(x=>x.P>0)
    .sort((a,b)=>(a.pct??999)-(b.pct??999))
    .slice(0,3);

  if(byBloco.length){
    byBloco.forEach(x=>{
      const pct = (x.pct==null?0:x.pct);
      const cls = pct < 70 ? "bad" : (pct < 85 ? "warn" : "good");
      el.appendChild(makeAlert(cls,
        `Bloco crítico: ${x.k} (${fmtPct0(pct)})`,
        `Saldo: ${fmtInt(x.P - x.E)} m`
      ));
    });
  }
}

function makeAlert(kind, title, tag){
  const d = document.createElement("div");
  d.className = `alert ${kind}`;
  d.innerHTML = `<div><strong>${title}</strong><div style="color:#6b7280;font-size:12px;margin-top:4px">Baseado no filtro atual</div></div><div class="tag">${tag}</div>`;
  return d;
}

/** ranking de riscos: score = (1-avanco)*peso + saldo + planejado */
function renderRiscos(rows){
  const byBloco = groupBy(rows,"Bloco").filter(x=>x.P>0);
  const ranked = byBloco.map(x=>{
    const pct = (x.E/x.P*100);
    const saldo = (x.P-x.E);
    const score = ((100-pct) * 50) + (saldo * 1) + (x.P * 0.1);
    return {bloco:x.k, score, saldo, pct};
  }).sort((a,b)=>b.score-a.score).slice(0,10);

  const labels = ranked.map(x=>x.bloco);
  const data = ranked.map(x=>Math.round(x.score));

  if(chartRiscos) chartRiscos.destroy();
  chartRiscos = new Chart(chRiscos, {
    type:"bar",
    data:{ labels, datasets:[{ label:"Score de risco", data }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{ display:false },
        tooltip:{ callbacks:{
          afterBody:(ctx)=>{
            const i = ctx[0].dataIndex;
            const r = ranked[i];
            return [
              `Avanço: ${r.pct.toFixed(0)}%`,
              `Saldo: ${fmtInt(r.saldo)} m`
            ];
          }
        }}
      }
    }
  });
}

/** ========= CURVA S + FORECAST =========
 * Só funciona se tiver coluna Data/data/Semana/semana no JSON.
 * Sem isso, deixa desabilitado.
 */
function renderCurvaS(rows){
  const hasDate = rows.some(r=>r.Data);
  const hint = document.getElementById("sForecast");

  if(!hasDate){
    hint.textContent = "Precisa de uma coluna de data para habilitar (ex.: Data, data, Semana, semana)";
    if(chartCurvaS){ chartCurvaS.destroy(); chartCurvaS=null; }
    return;
  }

  // normaliza datas/semana para string ordenável
  // aceita:
  // - "2026-02-19"
  // - "19/02/2026"
  // - "Semana 1", "S01", "1"
  function normKey(v){
    const s = String(v).trim();
    // dd/mm/yyyy
    const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(m) return `${m[3]}-${m[2]}-${m[1]}`;
    // yyyy-mm-dd
    const m2 = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(m2) return s;
    // semana numérica
    const n = s.match(/(\d+)/);
    if(n) return `SEM-${String(n[1]).padStart(3,"0")}`;
    return s;
  }

  const grouped = new Map();
  rows.forEach(r=>{
    if(!r.Data) return;
    const k = normKey(r.Data);
    if(!grouped.has(k)) grouped.set(k,{P:0,E:0});
    const g = grouped.get(k);
    g.P += Number(r.Planejado_m||0);
    g.E += Number(r.Executado_m||0);
  });

  const keys = [...grouped.keys()].sort((a,b)=>a.localeCompare(b));
  let accP=0, accE=0;
  const labels = keys;
  const cumP = [];
  const cumE = [];
  keys.forEach(k=>{
    const g = grouped.get(k);
    accP += g.P; accE += g.E;
    cumP.push(accP);
    cumE.push(accE);
  });

  // forecast simples: projeta linha executada até total planejado atual
  const totalP = accP || 0;
  const lastE = accE || 0;
  let forecast = new Array(labels.length).fill(null);

  // taxa média por período (evita dividir por zero)
  const periods = Math.max(1, labels.length-1);
  const avgE = lastE / Math.max(1, labels.length);
  if(totalP>0 && avgE>0){
    const remaining = totalP - lastE;
    const extraPoints = Math.min(6, Math.ceil(remaining / avgE)); // até +6 períodos
    const extLabels = [...labels];
    let e = lastE;
    for(let i=1;i<=extraPoints;i++){
      e += avgE;
      extLabels.push(`+${i}`);
      cumP.push(totalP);          // planejado “fecha” no total
      cumE.push(null);            // deixa histórico
      forecast.push(Math.min(e,totalP));
    }
    // garante o forecast começando no último ponto
    forecast = forecast.map((v,idx)=> v===null ? (idx===labels.length-1 ? lastE : null) : v);

    if(chartCurvaS) chartCurvaS.destroy();
    chartCurvaS = new Chart(chCurvaS, {
      type:"line",
      data:{
        labels: extLabels,
        datasets:[
          { label:"Planejado acumulado (m)", data: cumP, tension:.25 },
          { label:"Executado acumulado (m)", data: cumE.map((v,idx)=> idx < labels.length ? (idx===keys.length-1?lastE: (idx<keys.length? (cumE[idx] ?? null):null)) : null), tension:.25 },
          { label:"Forecast executado (m)", data: forecast, borderDash:[6,6], tension:.25 }
        ]
      },
      options:{ responsive:true, maintainAspectRatio:false }
    });
    hint.textContent = "Curva S habilitada (com forecast simples).";
  } else {
    hint.textContent = "Curva S habilitada, mas sem forecast (faltou volume/periodicidade suficiente).";
    if(chartCurvaS) chartCurvaS.destroy();
    chartCurvaS = new Chart(chCurvaS, {
      type:"line",
      data:{
        labels,
        datasets:[
          { label:"Planejado acumulado (m)", data: cumP, tension:.25 },
          { label:"Executado acumulado (m)", data: cumE, tension:.25 }
        ]
      },
      options:{ responsive:true, maintainAspectRatio:false }
    });
  }
}

/** ========= TABELA ========= */
function calcAvancoRow(r){
  const p = Number(r.Planejado_m||0);
  const e = Number(r.Executado_m||0);
  return p>0 ? (e/p*100) : null;
}
function setArrows(){
  const arrows = {Obra:"aObra",Bloco:"aBloco",Tipo:"aTipo",Planejado_m:"aPlan",Executado_m:"aExec",Avanco:"aAv"};
  for(const k in arrows) document.getElementById(arrows[k]).textContent = "";
  const id = arrows[sortState.col];
  if(id) document.getElementById(id).textContent = sortState.dir==="asc" ? "▲" : "▼";
}
function sortRows(rows){
  const col = sortState.col;
  const dir = sortState.dir === "asc" ? 1 : -1;

  return [...rows].sort((a,b)=>{
    let va, vb;

    if(col==="Avanco"){
      va = calcAvancoRow(a); vb = calcAvancoRow(b);
      if(va===null && vb===null) return 0;
      if(va===null) return 1;
      if(vb===null) return -1;
      return (va-vb)*dir;
    }
    if(col==="Planejado_m" || col==="Executado_m"){
      va = Number(a[col]||0); vb = Number(b[col]||0);
      return (va-vb)*dir;
    }
    va = String(a[col]||""); vb = String(b[col]||"");
    return va.localeCompare(vb)*dir;
  });
}
function renderTable(rows){
  const sorted = sortRows(rows);
  linhasInfo.textContent = "Linhas: " + sorted.length;
  setArrows();

  tbody.innerHTML = "";
  sorted.forEach(r=>{
    const av = calcAvancoRow(r);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.Obra||""}</td>
      <td>${r.Bloco||""}</td>
      <td>${r.Tipo||""}</td>
      <td class="num">${fmt1(r.Planejado_m)}</td>
      <td class="num">${fmt1(r.Executado_m)}</td>
      <td class="num">${av===null ? "—" : av.toFixed(0)+"%"}</td>
    `;
    tbody.appendChild(tr);
  });
}
function bindTableSort(){
  document.querySelectorAll("thead th").forEach(th=>{
    th.addEventListener("click", ()=>{
      const col = th.getAttribute("data-col");
      if(sortState.col === col) sortState.dir = (sortState.dir==="asc"?"desc":"asc");
      else { sortState.col = col; sortState.dir="asc"; }
      update();
    });
  });
}

/** ========= MAIN UPDATE ========= */
function update(){
  const rows = filtered();

  const plan = rows.reduce((s,r)=>s+Number(r.Planejado_m||0),0);
  const exec = rows.reduce((s,r)=>s+Number(r.Executado_m||0),0);
  const saldo = plan - exec;
  const av = plan>0 ? exec/plan*100 : 0;

  const pv = rows.reduce((s,r)=>s+Number(r.PV||0),0);
  const prof = rows.reduce((s,r)=>s+Number(r.Profundidade_m||0),0);
  const ecoPrev = rows.reduce((s,r)=>s+Number(r.Economias_Previstas||0),0);
  const ecoRec  = rows.reduce((s,r)=>s+Number(r.Economias_Recebidas||0),0);

  kPlan.textContent = fmtInt(plan);
  kExec.textContent = fmtInt(exec);
  kSaldo.textContent = fmtInt(saldo);
  kAvanco.textContent = av.toFixed(0) + "%";
  setCardAvancoColor(av);

  kPV.textContent = fmtInt(pv);
  kProf.textContent = fmtInt(prof);
  kEcoPrev.textContent = fmtInt(ecoPrev);
  kEcoRec.textContent = fmtInt(ecoRec);

  // Gráfico por Obra
  const byObra = groupBy(rows,"Obra").sort((a,b)=>String(a.k).localeCompare(String(b.k)));
  const labelsO = byObra.map(x=>x.k);
  const dataP = byObra.map(x=>x.P);
  const dataE = byObra.map(x=>x.E);

  if(chartObra) chartObra.destroy();
  chartObra = new Chart(chObra, {
    type:"bar",
    data:{ labels: labelsO, datasets:[
      { label:"Planejado (m)", data:dataP },
      { label:"Executado (m)", data:dataE }
    ]},
    options:{ responsive:true, maintainAspectRatio:false,
      scales:{ x:{ ticks:{ maxRotation:45, minRotation:45 } },
              y:{ title:{ display:true, text:"Metros (m)" } } }
    }
  });

  // Donut por Tipo
  const byTipo = groupBy(rows,"Tipo").sort((a,b)=>b.P-a.P);
  const labelsT = byTipo.map(x=>x.k);
  const dataT = byTipo.map(x=>x.P);

  if(chartTipo) chartTipo.destroy();
  chartTipo = new Chart(chTipo, {
    type:"doughnut",
    data:{ labels: labelsT, datasets:[{ data:dataT }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{ position:"right" },
        tooltip:{ callbacks:{
          label:(ctx)=>{
            const total = dataT.reduce((s,v)=>s+v,0) || 1;
            const v = ctx.raw || 0;
            const p = (v/total*100);
            return ` ${ctx.label}: ${fmt1(v)} m (${p.toFixed(1)}%)`;
          }
        }}
      },
      cutout:"60%"
    }
  });

  // Avanço % por Bloco
  const byBloco = groupBy(rows,"Bloco");
  const byBlocoName = [...byBloco].sort((a,b)=>String(a.k).localeCompare(String(b.k)));
  const labelsB = byBlocoName.map(x=>x.k);
  const dataAvB = byBlocoName.map(x=>{
    const pct = avancoPct(x.P,x.E);
    return pct===null ? 0 : pct;
  });

  if(chartAvBloco) chartAvBloco.destroy();
  chartAvBloco = new Chart(chAvancoBloco, {
    type:"bar",
    data:{ labels: labelsB, datasets:[{ label:"Avanço (%)", data:dataAvB }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ display:false } },
      scales:{ y:{ min:0, max:100, ticks:{ callback:(v)=>v+"%" } } }
    }
  });

  // Top 10 Executado por Bloco
  const top10 = [...byBloco].sort((a,b)=>b.E-a.E).slice(0,10);
  const labelsTop = top10.map(x=>x.k);
  const dataTop = top10.map(x=>x.E);

  if(chartTop10) chartTop10.destroy();
  chartTop10 = new Chart(chTop10, {
    type:"bar",
    data:{ labels: labelsTop, datasets:[{ label:"Executado (m)", data:dataTop }]},
    options:{ responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ display:false } }
    }
  });

  // Alertas + riscos + curva S/forecast
  renderAlerts(rows);
  renderRiscos(rows);
  renderCurvaS(rows);

  // Tabela
  renderTable(rows);
}

/** ========= LOAD DATA ========= */
async function loadData(){
  try{
    const res = await fetch("./dados.json?cb="+Date.now());
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();

    const updated = json.atualizado_em || "-";
    document.getElementById("pAtualizado").textContent = `Atualizado: ${updated}`;

    const registros = (json.registros || []).map(normalizeRow);
    RAW = registros;

    meta.textContent = `Atualizado em: ${updated} | Linhas: ${RAW.length}`;

    fillSelect(fObra, uniq(RAW.map(r=>r.Obra)).sort(), "(Todas)");
    fillSelect(fBloco, uniq(RAW.map(r=>r.Bloco)).sort(), "(Todos)");
    fillSelect(fTipo, uniq(RAW.map(r=>r.Tipo)).sort(), "(Todos)");

    update();
  } catch(err){
    console.error(err);
    alert("NÃO consegui carregar o dados.json. Verifique se o servidor está rodando na pasta docs e se o arquivo existe.");
  }
}

/** ========= INIT ========= */
function bindUI(){
  [fObra,fBloco,fTipo].forEach(el => el.addEventListener("change", update));
  bindTableSort();

  btnRefresh.addEventListener("click", loadData);
  btnPDF.addEventListener("click", ()=>window.print());
}

bindUI();
loadData();
</script>
</body>
</html>
