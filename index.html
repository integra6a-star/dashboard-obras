<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard – Acompanhamento de Obras</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

  <style>
    body{
      background:#0b1220;
      color:#ffffff;
      font-family: Arial, sans-serif;
    }

    .card{
      background:#0f172a;
      border:1px solid #334155;
      color:#ffffff;
    }

    h3,h4,h5{
      color:#ffffff;
    }

    .muted{
      color:#cbd5e1;
    }

    /* ===== TABELA ===== */
    .table-responsive{
      background:#0f172a;
      border-radius:6px;
      overflow:hidden;
    }

    table{
      width:100%;
      border-collapse:collapse;
    }

    thead th{
      background:#1e293b !important;
      color:#ffffff !important;
      font-weight:700;
      padding:12px;
      border-bottom:2px solid #94a3b8;
      cursor:pointer;
    }

    tbody td{
      background:#0f172a !important;
      color:#ffffff !important;
      padding:10px;
      border-bottom:1px solid #334155;
    }

    tbody tr:nth-child(odd) td{
      background:#0b1630 !important;
    }

    tbody tr:hover td{
      background:#24324a !important;
    }

    .text-end{
      text-align:right;
    }

    /* Selects */
    select.form-select{
      background:#0f172a;
      color:#ffffff;
      border:1px solid #334155;
    }

    option{
      background:#0f172a;
      color:#ffffff;
    }

    /* KPI */
    .kpi-label{
      color:#cbd5e1;
      font-size:14px;
    }

    .kpi-value{
      font-size:28px;
      font-weight:bold;
      color:#ffffff;
    }
  </style>
</head>

<body>
<div class="container-fluid p-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3>Dashboard – Acompanhamento de Obras</h3>
      <div class="muted" id="subtitle">Fonte: dados.json</div>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-light btn-sm" onclick="resetFilters()">Limpar filtros</button>
      <button class="btn btn-outline-light btn-sm" onclick="reloadData()">Recarregar dados</button>
    </div>
  </div>

  <div class="muted mb-3" id="status">Carregando dados…</div>

  <!-- Filtros -->
  <div class="card p-3 mb-3">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="kpi-label">Obra</label>
        <select id="obraSelect" class="form-select" onchange="renderAll()"></select>
      </div>
      <div class="col-md-4">
        <label class="kpi-label">Bloco</label>
        <select id="blocoSelect" class="form-select" onchange="renderAll()"></select>
      </div>
      <div class="col-md-4">
        <label class="kpi-label">Tipo</label>
        <select id="tipoSelect" class="form-select" onchange="renderAll()"></select>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="card p-3">
        <div class="kpi-label">Planejado (m)</div>
        <div class="kpi-value" id="kpiPlan">–</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <div class="kpi-label">Executado (m)</div>
        <div class="kpi-value" id="kpiExec">–</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <div class="kpi-label">Saldo (m)</div>
        <div class="kpi-value" id="kpiSaldo">–</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3">
        <div class="kpi-label">Avanço (%)</div>
        <div class="kpi-value" id="kpiAvanco">–</div>
      </div>
    </div>
  </div>

  <!-- TABELA -->
  <div class="card p-3">
    <div class="d-flex justify-content-between mb-2">
      <div>
        <strong>Tabela detalhada</strong><br>
        <span class="muted">Clique no cabeçalho para ordenar</span>
      </div>
      <div class="muted">Linhas: <span id="rowCount">0</span></div>
    </div>

    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th onclick="sortTable('Obra')">Obra</th>
            <th onclick="sortTable('Bloco')">Bloco</th>
            <th onclick="sortTable('Tipo Extensao')">Tipo</th>
            <th onclick="sortTable('Extensao Planejada')" class="text-end">Planejado (m)</th>
            <th onclick="sortTable('Extensao Executada')" class="text-end">Executado (m)</th>
            <th onclick="sortTable('Avanco_pct')" class="text-end">Avanço (%)</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
let RAW=[];
let currentSort={key:'Obra',dir:1};

function fmt(n){return Number(n||0).toLocaleString('pt-BR',{maximumFractionDigits:1});}
function pct(n){return (n*100).toLocaleString('pt-BR',{maximumFractionDigits:1})+'%';}

async function reloadData(){
  const r=await fetch("dados.json?"+Date.now());
  RAW=await r.json();
  initFilters();
  renderAll();
  document.getElementById('status').innerText="Dados carregados: "+RAW.length;
}

function initFilters(){
  const obras=[...new Set(RAW.map(r=>r.Obra))];
  const blocos=[...new Set(RAW.map(r=>r.Bloco))];
  const tipos=[...new Set(RAW.map(r=>r["Tipo Extensao"]))];

  obraSelect.innerHTML=['(Todas)',...obras].map(v=>`<option>${v}</option>`).join('');
  blocoSelect.innerHTML=['(Todos)',...blocos].map(v=>`<option>${v}</option>`).join('');
  tipoSelect.innerHTML=['(Todos)',...tipos].map(v=>`<option>${v}</option>`).join('');
}

function getFiltered(){
  return RAW.filter(r=>
    (obraSelect.value=='(Todas)'||r.Obra==obraSelect.value) &&
    (blocoSelect.value=='(Todos)'||String(r.Bloco)==blocoSelect.value) &&
    (tipoSelect.value=='(Todos)'||r["Tipo Extensao"]==tipoSelect.value)
  );
}

function renderAll(){
  const rows=getFiltered();
  const plan=rows.reduce((s,r)=>s+r["Extensao Planejada"],0);
  const exec=rows.reduce((s,r)=>s+r["Extensao Executada"],0);

  kpiPlan.innerText=fmt(plan);
  kpiExec.innerText=fmt(exec);
  kpiSaldo.innerText=fmt(plan-exec);
  kpiAvanco.innerText=plan?pct(exec/plan):'–';

  renderTable(rows);
}

function renderTable(rows){
  rows.sort((a,b)=>currentSort.dir*(String(a[currentSort.key]).localeCompare(String(b[currentSort.key]))));
  tableBody.innerHTML=rows.map(r=>`
    <tr>
      <td>${r.Obra}</td>
      <td>${r.Bloco}</td>
      <td>${r["Tipo Extensao"]}</td>
      <td class="text-end">${fmt(r["Extensao Planejada"])}</td>
      <td class="text-end">${fmt(r["Extensao Executada"])}</td>
      <td class="text-end">${pct(r.Avanco_pct)}</td>
    </tr>
  `).join('');
  rowCount.innerText=rows.length;
}

function sortTable(k){
  currentSort.dir*=-1;
  currentSort.key=k;
  renderAll();
}

function resetFilters(){
  obraSelect.value='(Todas)';
  blocoSelect.value='(Todos)';
  tipoSelect.value='(Todos)';
  renderAll();
}

reloadData();
</script>
</body>
</html>
