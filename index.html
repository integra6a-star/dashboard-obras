<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard – Acompanhamento de Obras</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --primary:#2563eb;
      --primary-soft:#e8efff;
    }

    body{
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .muted{ color: var(--muted); }
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: 0 2px 10px rgba(15,23,42,.06);
      border-radius: 14px;
    }

    .badge-soft{
      background: var(--primary-soft);
      color: var(--primary);
      border: 1px solid rgba(37,99,235,.15);
      font-weight: 600;
    }

    .kpi-label{ font-size:.85rem; color: var(--muted); }
    .kpi-value{ font-size: 1.9rem; font-weight: 800; color: var(--primary); line-height: 1.1; }

    .plot{ height: 360px; }
    .plot-sm{ height: 320px; }

    table{ width:100%; border-collapse: collapse; }
    thead th{
      background: var(--primary);
      color:#fff;
      padding: 12px 10px;
      font-weight: 700;
      border-bottom: 2px solid rgba(255,255,255,.2);
      white-space: nowrap;
    }
    tbody td{
      padding: 10px;
      border-bottom: 1px solid var(--border);
      color: var(--text);
      vertical-align: middle;
    }
    tbody tr:nth-child(even){ background: #f1f5f9; }
    tbody tr:hover{ background: #e2e8f0; }

    .form-select{
      border-radius: 10px;
      border-color: var(--border);
    }
  </style>
</head>

<body>
<div class="container-fluid p-3 p-md-4">
  <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-3">
    <div>
      <h3 class="mb-1">Dashboard – Acompanhamento de Obras</h3>
      <div id="subtitle" class="muted">Carregando dados…</div>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <span class="badge badge-soft rounded-pill p-2">Filtros: Obra / Bloco / Tipo</span>
      <button class="btn btn-sm btn-outline-dark" onclick="resetFilters()">Limpar filtros</button>
      <button class="btn btn-sm btn-primary" onclick="reloadData()">Recarregar dados</button>
    </div>
  </div>

  <div id="status" class="muted small mb-3">Carregando dados…</div>

  <!-- Filtros -->
  <div class="card p-3 mb-3">
    <div class="row g-3">
      <div class="col-12 col-md-4">
        <label class="kpi-label mb-1">Obra</label>
        <select id="obraSelect" class="form-select" onchange="renderAll()" disabled></select>
      </div>
      <div class="col-12 col-md-4">
        <label class="kpi-label mb-1">Bloco</label>
        <select id="blocoSelect" class="form-select" onchange="renderAll()" disabled></select>
      </div>
      <div class="col-12 col-md-4">
        <label class="kpi-label mb-1">Tipo de extensão</label>
        <select id="tipoSelect" class="form-select" onchange="renderAll()" disabled></select>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-12 col-md-3">
      <div class="card p-3 h-100">
        <div class="kpi-label">Extensão Planejada (m)</div>
        <div id="kpiPlan" class="kpi-value">–</div>
        <div class="muted small">Somatório do filtro</div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card p-3 h-100">
        <div class="kpi-label">Extensão Executada (m)</div>
        <div id="kpiExec" class="kpi-value">–</div>
        <div class="muted small">Somatório do filtro</div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card p-3 h-100">
        <div class="kpi-label">Saldo a Executar (m)</div>
        <div id="kpiSaldo" class="kpi-value">–</div>
        <div class="muted small">Planejado – Executado</div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card p-3 h-100">
        <div class="kpi-label">Avanço (%)</div>
        <div id="kpiAvanco" class="kpi-value">–</div>
        <div class="muted small">Executado / Planejado</div>
      </div>
    </div>
  </div>

  <!-- Gráficos -->
  <div class="row g-3 mb-3">
    <div class="col-12 col-lg-8">
      <div class="card p-3 h-100">
        <div class="fw-semibold">Planejado × Executado por Obra</div>
        <div class="muted small mb-2">Colunas agrupadas</div>
        <div id="chartPxE" class="plot"></div>
      </div>
    </div>
    <div class="col-12 col-lg-4">
      <div class="card p-3 h-100">
        <div class="fw-semibold">Distribuição por Tipo</div>
        <div class="muted small mb-2">Participação do Planejado (m)</div>
        <div id="chartTipos" class="plot"></div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-12 col-lg-6">
      <div class="card p-3 h-100">
        <div class="fw-semibold">Avanço (%) por Bloco</div>
        <div class="muted small mb-2">Executado / Planejado</div>
        <div id="chartAvanco" class="plot-sm"></div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card p-3 h-100">
        <div class="fw-semibold">Ranking – Top 10 Executado (m)</div>
        <div class="muted small mb-2">Blocos com maior produção</div>
        <div id="chartTop10" class="plot-sm"></div>
      </div>
    </div>
  </div>

  <!-- Tabela -->
  <div class="card p-3">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
      <div>
        <div class="fw-semibold">Tabela detalhada</div>
        <div class="muted small">Ordene clicando no cabeçalho</div>
      </div>
      <div class="muted small">Linhas: <span id="rowCount">–</span></div>
    </div>

    <div class="table-responsive">
      <table class="align-middle mb-0">
        <thead>
          <tr>
            <th onclick="sortTable('Obra')" style="cursor:pointer">Obra</th>
            <th onclick="sortTable('Bloco')" style="cursor:pointer">Bloco</th>
            <th onclick="sortTable('Tipo_Extensao')" style="cursor:pointer">Tipo</th>
            <th onclick="sortTable('Extensao_Planejada_m')" style="cursor:pointer" class="text-end">Planejado (m)</th>
            <th onclick="sortTable('Extensao_Executada_m')" style="cursor:pointer" class="text-end">Executado (m)</th>
            <th onclick="sortTable('Avanco_pct')" style="cursor:pointer" class="text-end">Avanço (%)</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <div class="muted small mt-3">
    Dica: se estiver vendo dados antigos, clique em <b>Recarregar dados</b>.
  </div>
</div>

<script>
let RAW = [];
let currentSort = { key: 'Obra', dir: 1 };

function setStatus(msg){ document.getElementById('status').innerText = msg; }
function setSubtitle(msg){ document.getElementById('subtitle').innerText = msg; }

function enableControls(enabled){
  document.getElementById('obraSelect').disabled = !enabled;
  document.getElementById('blocoSelect').disabled = !enabled;
  document.getElementById('tipoSelect').disabled = !enabled;
}

function fmtNumber(x){
  if (x === null || x === undefined || isNaN(x)) return "–";
  return Number(x).toLocaleString('pt-BR', {maximumFractionDigits: 1});
}
function fmtPct(x){
  if (x === null || x === undefined || isNaN(x)) return "–";
  return (100*Number(x)).toLocaleString('pt-BR', {maximumFractionDigits: 1}) + "%";
}
function uniq(arr){
  return Array.from(new Set(arr.filter(v=>v!==null && v!==undefined)))
    .sort((a,b)=>String(a).localeCompare(String(b),'pt-BR'));
}

async function reloadData(){
  try{
    enableControls(false);
    setStatus("Carregando dados…");

    const resp = await fetch("dados.json?cache=" + Date.now());
    if(!resp.ok) throw new Error("HTTP " + resp.status);
    RAW = await resp.json();

    // Normaliza números + cria Avanco_pct
    RAW.forEach(r=>{
      r["Extensao_Planejada_m"] = Number(String(r["Extensao_Planejada_m"] ?? "0").replace(",", ".")) || 0;
      r["Extensao_Executada_m"] = Number(String(r["Extensao_Executada_m"] ?? "0").replace(",", ".")) || 0;

      r["Avanco_pct"] = (r["Extensao_Planejada_m"]>0)
        ? (r["Extensao_Executada_m"]/r["Extensao_Planejada_m"])
        : null;
    });

    initFilters();
    resetFilters();

    setStatus("Dados carregados: " + RAW.length.toLocaleString('pt-BR') + " linhas.");
    setSubtitle("Fonte: dados.json (gerado do Excel) • Atualize o Excel e rode o script.");
    enableControls(true);
  }catch(e){
    console.error(e);
    setStatus("Erro ao carregar dados.json. Confira se está no mesmo local do index.html.");
  }
}

function initFilters(){
  const obraSel = document.getElementById('obraSelect');
  const blocoSel = document.getElementById('blocoSelect');
  const tipoSel = document.getElementById('tipoSelect');

  const obras = ['(Todas)'].concat(uniq(RAW.map(r=>r["Obra"])));
  const blocos = ['(Todos)'].concat(uniq(RAW.map(r=>r["Bloco"])));
  const tipos = ['(Todos)'].concat(uniq(RAW.map(r=>r["Tipo_Extensao"])));

  obraSel.innerHTML = obras.map(o=>`<option value="${o}">${o}</option>`).join('');
  blocoSel.innerHTML = blocos.map(b=>`<option value="${b}">${b}</option>`).join('');
  tipoSel.innerHTML = tipos.map(t=>`<option value="${t}">${t}</option>`).join('');
}

function getFiltered(){
  const obra = document.getElementById('obraSelect').value;
  const bloco = document.getElementById('blocoSelect').value;
  const tipo = document.getElementById('tipoSelect').value;

  return RAW.filter(r=>{
    const okObra = (obra === '(Todas)') || (r["Obra"] === obra);
    const okBloco = (bloco === '(Todos)') || (String(r["Bloco"]) === String(bloco));
    const okTipo = (tipo === '(Todos)') || (r["Tipo_Extensao"] === tipo);
    return okObra && okBloco && okTipo;
  });
}

function sum(rows, key){ return rows.reduce((acc,r)=>acc + (Number(r[key])||0), 0); }

function renderKPIs(rows){
  const plan = sum(rows, "Extensao_Planejada_m");
  const exec = sum(rows, "Extensao_Executada_m");
  const saldo = plan - exec;
  const avanco = (plan>0) ? (exec/plan) : NaN;

  document.getElementById('kpiPlan').innerText = fmtNumber(plan);
  document.getElementById('kpiExec').innerText = fmtNumber(exec);
  document.getElementById('kpiSaldo').innerText = fmtNumber(saldo);
  document.getElementById('kpiAvanco').innerText = fmtPct(avanco);
}

function groupBy(rows, key){
  const m = new Map();
  rows.forEach(r=>{
    const k = r[key];
    if(!m.has(k)) m.set(k, []);
    m.get(k).push(r);
  });
  return m;
}

function plotLayoutBase(){
  return {
    paper_bgcolor:'rgba(0,0,0,0)',
    plot_bgcolor:'rgba(0,0,0,0)',
    font:{color:'#0f172a'},
    xaxis:{ gridcolor:'rgba(15,23,42,.06)' },
    yaxis:{ gridcolor:'rgba(15,23,42,.08)' },
    margin:{l:60,r:20,t:10,b:90},
    legend:{orientation:'h', y:1.12}
  };
}

/* ✅ AQUI É O QUE VOCÊ PEDIU:
   - eixo X = OBRA
   - Planejado azul / Executado verde
*/
function renderPxE(rows){
  const byObra = groupBy(rows, "Obra");
  const obras = Array.from(byObra.keys()).sort((a,b)=>String(a).localeCompare(String(b),'pt-BR'));

  const planned = obras.map(o => sum(byObra.get(o), "Extensao_Planejada_m"));
  const executed = obras.map(o => sum(byObra.get(o), "Extensao_Executada_m"));

  const t1 = { x: obras, y: planned, type:'bar', name:'Planejado (m)', marker:{color:'#2563eb'} }; // azul
  const t2 = { x: obras, y: executed, type:'bar', name:'Executado (m)', marker:{color:'#16a34a'} }; // verde

  const layout = plotLayoutBase();
  layout.barmode = 'group';
  layout.yaxis = {title:'Metros (m)', gridcolor:'rgba(15,23,42,.10)'};
  layout.xaxis = {tickangle:-30, gridcolor:'rgba(15,23,42,.06)'};

  Plotly.newPlot('chartPxE',[t1,t2],layout,{displaylogo:false,responsive:true});
}

function renderTipos(rows){
  const byTipo = groupBy(rows, "Tipo_Extensao");
  const tipos = Array.from(byTipo.keys()).sort((a,b)=>String(a).localeCompare(String(b),'pt-BR'));
  const planned = tipos.map(t=> sum(byTipo.get(t), "Extensao_Planejada_m"));

  const trace = { labels: tipos, values: planned, type:'pie', textinfo:'label+percent', hole:0.55 };
  const layout = {
    paper_bgcolor:'rgba(0,0,0,0)',
    plot_bgcolor:'rgba(0,0,0,0)',
    font:{color:'#0f172a'},
    margin:{l:10,r:10,t:10,b:10},
    showlegend:false
  };
  Plotly.newPlot('chartTipos',[trace],layout,{displaylogo:false,responsive:true});
}

function renderAvanco(rows){
  const byBloco = groupBy(rows, "Bloco");
  const blocos = Array.from(byBloco.keys()).sort((a,b)=>String(a).localeCompare(String(b),'pt-BR'));

  const av = blocos.map(b=>{
    const plan = sum(byBloco.get(b), "Extensao_Planejada_m");
    const exec = sum(byBloco.get(b), "Extensao_Executada_m");
    return (plan>0) ? (exec/plan) : null;
  });

  const trace = { x: blocos, y: av.map(v=>v===null?null:100*v), type:'bar', name:'Avanço (%)' };

  const layout = plotLayoutBase();
  layout.yaxis = {title:'%', gridcolor:'rgba(15,23,42,.10)'};
  layout.xaxis = {tickangle:-35, gridcolor:'rgba(15,23,42,.06)'};

  Plotly.newPlot('chartAvanco',[trace],layout,{displaylogo:false,responsive:true});
}

function renderTop10(rows){
  const byBloco = groupBy(rows, "Bloco");
  const items = Array.from(byBloco.entries()).map(([b, rs])=>{
    return { bloco:b, exec: sum(rs,"Extensao_Executada_m") };
  }).sort((a,b)=>b.exec - a.exec).slice(0,10);

  const trace = { x: items.map(i=>i.bloco), y: items.map(i=>i.exec), type:'bar', name:'Executado (m)' };

  const layout = plotLayoutBase();
  layout.yaxis = {title:'Metros (m)', gridcolor:'rgba(15,23,42,.10)'};
  layout.xaxis = {tickangle:-35, gridcolor:'rgba(15,23,42,.06)'};

  Plotly.newPlot('chartTop10',[trace],layout,{displaylogo:false,responsive:true});
}

function renderTable(rows){
  const k = currentSort.key;
  const dir = currentSort.dir;

  const sorted = [...rows].sort((a,b)=>{
    if (k === "Avanco_pct") {
      const aa = (a["Extensao_Planejada_m"]>0) ? a["Extensao_Executada_m"]/a["Extensao_Planejada_m"] : -1;
      const bb = (b["Extensao_Planejada_m"]>0) ? b["Extensao_Executada_m"]/b["Extensao_Planejada_m"] : -1;
      return dir*(aa-bb);
    }

    const va=a[k], vb=b[k];
    const na=Number(va), nb=Number(vb);
    const bothNum = !isNaN(na) && !isNaN(nb) && va!==null && vb!==null;

    if (bothNum) return dir*(na-nb);
    return dir*String(va).localeCompare(String(vb),'pt-BR');
  });

  const body = document.getElementById('tableBody');
  body.innerHTML = sorted.map(r=>`
    <tr>
      <td>${r["Obra"] ?? ""}</td>
      <td>${r["Bloco"] ?? ""}</td>
      <td>${r["Tipo_Extensao"] ?? ""}</td>
      <td class="text-end">${fmtNumber(r["Extensao_Planejada_m"])}</td>
      <td class="text-end">${fmtNumber(r["Extensao_Executada_m"])}</td>
      <td class="text-end">${fmtPct(r["Avanco_pct"])}</td>
    </tr>
  `).join('');

  document.getElementById('rowCount').innerText = sorted.length.toLocaleString('pt-BR');
}

function sortTable(key){
  if(currentSort.key===key) currentSort.dir=-currentSort.dir;
  else { currentSort.key=key; currentSort.dir=1; }
  renderAll();
}

function resetFilters(){
  document.getElementById('obraSelect').value='(Todas)';
  document.getElementById('blocoSelect').value='(Todos)';
  document.getElementById('tipoSelect').value='(Todos)';
  currentSort = { key:'Obra', dir:1 };
  renderAll();
}

function renderAll(){
  const rows = getFiltered();
  renderKPIs(rows);
  renderPxE(rows);
  renderTipos(rows);
  renderAvanco(rows);
  renderTop10(rows);
  renderTable(rows);
}

reloadData();
</script>
</body>
</html>
